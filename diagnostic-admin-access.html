<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Panel Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-left: 4px solid #4caf50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        .info { border-left: 4px solid #2196f3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a8b;
        }
        .result {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>üîß Diagnostic Panel Admin</h1>
        <p>Cet outil diagnostique pourquoi le panel admin n'appara√Æt pas pour un compte super admin.</p>

        <div class="test-section info">
            <h3>üìã √âtapes de diagnostic</h3>
            <button onclick="runFullDiagnostic()">üöÄ Lancer diagnostic complet</button>
            <button onclick="testAuthentication()">üîë Test authentification</button>
            <button onclick="testAdminAccess()">üëë Test acc√®s admin</button>
            <button onclick="testPageVisibility()">üëÅÔ∏è Test visibilit√© page</button>
        </div>

        <div id="results"></div>

        <!-- Section de connexion pour les tests -->
        <div class="test-section">
            <h3>üîê Connexion pour tests</h3>
            <div>
                <input type="email" id="testEmail" placeholder="Email" style="padding: 8px; margin: 5px;">
                <input type="password" id="testPassword" placeholder="Mot de passe" style="padding: 8px; margin: 5px;">
                <button onclick="testLogin()">Se connecter</button>
                <button onclick="testLogout()">Se d√©connecter</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        import { SUPABASE_CONFIG } from './js/config.js';
        import { authManager } from './js/auth.js';

        let supabase = null;

        // Initialiser Supabase
        if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.url !== 'YOUR_SUPABASE_URL') {
            supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            authManager.init();
        }

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <div class="result">${content}</div>
            `;
            results.appendChild(div);
        }

        window.runFullDiagnostic = async function() {
            document.getElementById('results').innerHTML = '';
            addResult('üöÄ Diagnostic d√©marr√©...', 'Ex√©cution de tous les tests', 'info');
            
            await testAuthentication();
            await testAdminAccess();
            await testPageVisibility();
            await testSupabaseConnection();
            await testUserProfile();
        };

        window.testAuthentication = async function() {
            try {
                if (!supabase) {
                    addResult('‚ùå Supabase non configur√©', 'Supabase n\'est pas initialis√©', 'error');
                    return;
                }

                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    addResult('‚ùå Erreur authentification', `<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
                    return;
                }

                if (!user) {
                    addResult('‚ö†Ô∏è Utilisateur non connect√©', 'Aucun utilisateur authentifi√©', 'warning');
                    return;
                }

                addResult('‚úÖ Utilisateur authentifi√©', `
                    <pre>ID: ${user.id}
Email: ${user.email}
Cr√©√©: ${user.created_at}</pre>
                `, 'success');

            } catch (error) {
                addResult('‚ùå Exception authentification', `<pre>${error.message}</pre>`, 'error');
            }
        };

        window.testAdminAccess = async function() {
            try {
                const hasAccess = await authManager.hasAdminAccess();
                
                if (hasAccess) {
                    addResult('‚úÖ Acc√®s admin confirm√©', 'L\'utilisateur a bien les droits admin', 'success');
                } else {
                    addResult('‚ùå Pas d\'acc√®s admin', 'L\'utilisateur n\'a pas les droits admin', 'error');
                }

            } catch (error) {
                addResult('‚ùå Erreur test admin', `<pre>${error.message}</pre>`, 'error');
            }
        };

        window.testUserProfile = async function() {
            try {
                const profile = await authManager.getUserProfile();
                
                if (!profile) {
                    addResult('‚ùå Profil non trouv√©', 'Impossible de r√©cup√©rer le profil utilisateur', 'error');
                    return;
                }

                addResult('üìä Profil utilisateur', `
                    <pre>ID: ${profile.id}
Email: ${profile.email}
Nom: ${profile.full_name || 'Non d√©fini'}
Super Admin: ${profile.is_super_admin ? 'OUI' : 'NON'}
R√¥le: ${profile.roles ? profile.roles.display_name : 'Aucun r√¥le'}
Niveau r√¥le: ${profile.roles ? profile.roles.level : 'N/A'}</pre>
                `, profile.is_super_admin ? 'success' : 'warning');

            } catch (error) {
                addResult('‚ùå Erreur profil', `<pre>${error.message}</pre>`, 'error');
            }
        };

        window.testPageVisibility = function() {
            const adminLink = document.querySelector('a[href="admin.html"]');
            const adminBtn = document.getElementById('adminBtn');
            
            let visibility = [];
            
            if (adminLink) {
                const style = window.getComputedStyle(adminLink);
                visibility.push(`Lien admin.html: ${style.display !== 'none' ? 'VISIBLE' : 'CACH√â'}`);
            } else {
                visibility.push('Lien admin.html: NON TROUV√â');
            }
            
            if (adminBtn) {
                const style = window.getComputedStyle(adminBtn);
                visibility.push(`Bouton admin: ${style.display !== 'none' ? 'VISIBLE' : 'CACH√â'}`);
            } else {
                visibility.push('Bouton admin: NON TROUV√â');
            }

            addResult('üëÅÔ∏è Visibilit√© √©l√©ments admin', `<pre>${visibility.join('\n')}</pre>`, 
                     visibility.some(v => v.includes('VISIBLE')) ? 'success' : 'warning');
        };

        window.testSupabaseConnection = async function() {
            try {
                if (!supabase) {
                    addResult('‚ùå Pas de connexion Supabase', 'Client Supabase non initialis√©', 'error');
                    return;
                }

                // Test de connexion basique
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                
                if (error) {
                    addResult('‚ùå Erreur connexion DB', `<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
                } else {
                    addResult('‚úÖ Connexion DB OK', 'Connexion √† la base de donn√©es r√©ussie', 'success');
                }

            } catch (error) {
                addResult('‚ùå Exception Supabase', `<pre>${error.message}</pre>`, 'error');
            }
        };

        window.testLogin = async function() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            if (!email || !password) {
                addResult('‚ö†Ô∏è Identifiants manquants', 'Veuillez saisir email et mot de passe', 'warning');
                return;
            }

            try {
                const result = await authManager.signIn(email, password);
                addResult('‚úÖ Connexion r√©ussie', `Connect√© en tant que: ${result.user.email}`, 'success');
                
                // Relancer les tests
                setTimeout(() => runFullDiagnostic(), 1000);
                
            } catch (error) {
                addResult('‚ùå √âchec connexion', `<pre>${error.message}</pre>`, 'error');
            }
        };

        window.testLogout = async function() {
            try {
                await authManager.signOut();
                addResult('‚úÖ D√©connexion r√©ussie', 'Utilisateur d√©connect√©', 'success');
            } catch (error) {
                addResult('‚ùå Erreur d√©connexion', `<pre>${error.message}</pre>`, 'error');
            }
        };

        // Test automatique au chargement
        setTimeout(() => {
            if (supabase) {
                runFullDiagnostic();
            } else {
                addResult('‚ùå Configuration manquante', 'Supabase n\'est pas configur√©', 'error');
            }
        }, 1000);
    </script>
</body>
</html>