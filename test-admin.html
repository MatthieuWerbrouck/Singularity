<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Admin Access Simple</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test Acc√®s Admin</h1>
    <div id="results"></div>
    
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        import { SUPABASE_CONFIG } from './js/config.js';

        const results = document.getElementById('results');

        function addResult(message, type = 'success') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function testAdminAccess() {
            try {
                // Test 1: Configuration Supabase
                if (!SUPABASE_CONFIG.url || SUPABASE_CONFIG.url === 'YOUR_SUPABASE_URL') {
                    addResult('‚ùå Supabase non configur√©', 'error');
                    return;
                }

                const supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                addResult('‚úÖ Supabase initialis√©');

                // Test 2: Utilisateur connect√©
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError) {
                    addResult(`‚ùå Erreur auth: ${authError.message}`, 'error');
                    return;
                }

                if (!user) {
                    addResult('‚ö†Ô∏è Aucun utilisateur connect√© - connectez-vous d\'abord', 'warning');
                    return;
                }

                addResult(`‚úÖ Utilisateur connect√©: ${user.email}`);

                // Test 3: R√©cup√©rer le profil
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select(`
                        id,
                        email,
                        full_name,
                        is_super_admin,
                        roles(id, name, display_name, level)
                    `)
                    .eq('id', user.id)
                    .single();

                if (profileError) {
                    addResult(`‚ùå Erreur profil: ${profileError.message}`, 'error');
                    return;
                }

                if (!profile) {
                    addResult('‚ùå Profil non trouv√©', 'error');
                    return;
                }

                addResult(`‚úÖ Profil trouv√©: ${profile.email}`);
                
                // Test 4: V√©rifier les permissions admin
                const isSuper = profile.is_super_admin;
                const roleLevel = profile.roles ? profile.roles.level : 0;
                const roleName = profile.roles ? profile.roles.name : 'aucun';

                addResult(`<pre>Super Admin: ${isSuper ? 'OUI' : 'NON'}
R√¥le: ${roleName}
Niveau r√¥le: ${roleLevel || 'N/A'}</pre>`);

                // Test 5: D√©terminer l'acc√®s admin
                const hasAdminAccess = isSuper || (roleLevel >= 80) || ['admin', 'super_admin'].includes(roleName);

                if (hasAdminAccess) {
                    addResult('üéâ ACC√àS ADMIN CONFIRM√â - Le bouton admin devrait appara√Ætre', 'success');
                    
                    // Test 6: V√©rifier si le bouton admin existe
                    setTimeout(() => {
                        const adminCard = document.querySelector('[data-module="admin"]');
                        if (adminCard) {
                            addResult('‚úÖ Carte admin trouv√©e dans le DOM');
                        } else {
                            addResult('‚ùå Carte admin NON trouv√©e - probl√®me de logique d\'affichage', 'error');
                        }
                    }, 2000);
                    
                } else {
                    addResult('‚ùå PAS D\'ACC√àS ADMIN - Permissions insuffisantes', 'error');
                    addResult('üí° Solution: Mettez is_super_admin = true pour cet utilisateur', 'warning');
                }

            } catch (error) {
                addResult(`‚ùå Exception: ${error.message}`, 'error');
            }
        }

        // Lancer le test
        testAdminAccess();
    </script>
</body>
</html>