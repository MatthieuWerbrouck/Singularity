<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Singularity</title>
    <link rel="stylesheet" href="./styles/main.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .users-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-active { color: #10b981; }
        .status-inactive { color: #6b7280; }
        .status-suspended { color: #dc2626; }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <nav class="navbar">
                <h1>üëë Administration - Singularity</h1>
                <div class="nav-links">
                    <a href="index.html" class="btn btn-secondary">‚Üê Retour Dashboard</a>
                    <button id="logoutBtn" class="btn btn-secondary">D√©connexion</button>
                </div>
            </nav>
        </header>

        <main>
            <div class="admin-container">
                <h2>Gestion des Utilisateurs</h2>
                
                <div id="loading" style="text-align: center; padding: 40px;">
                    <p>üîÑ Chargement des donn√©es...</p>
                </div>
                
                <div id="adminContent" style="display: none;">
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="stat-card">
                            <h3>üë• Utilisateurs Total</h3>
                            <p id="totalUsers">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>üëë Super Admins</h3>
                            <p id="totalSuperAdmins">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>üõ†Ô∏è Admins</h3>
                            <p id="totalAdmins">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>‚úÖ Actifs</h3>
                            <p id="activeUsers">0</p>
                        </div>
                    </div>

                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Nom</th>
                                <th>R√¥le</th>
                                <th>Statut</th>
                                <th>Inscrit le</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        import { SUPABASE_CONFIG } from './js/config.js';

        const supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        async function loadAdminData() {
            try {
                // V√©rifier l'authentification
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }

                // Charger les utilisateurs avec leurs r√¥les
                const { data: users, error } = await supabase
                    .from('profiles')
                    .select(`
                        id,
                        email,
                        full_name,
                        is_super_admin,
                        status,
                        created_at,
                        roles (
                            name,
                            display_name,
                            color,
                            icon
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayUsers(users);
                updateStats(users);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML = `<p style="color: red;">‚ùå Erreur: ${error.message}</p>`;
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                
                const roleName = user.is_super_admin ? 'Super Admin üëë' : 
                               (user.roles?.display_name || 'Aucun r√¥le');
                const roleColor = user.is_super_admin ? '#dc2626' : 
                                (user.roles?.color || '#6b7280');

                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${user.full_name || '-'}</td>
                    <td>
                        <span class="role-badge" style="background-color: ${roleColor}20; color: ${roleColor};">
                            ${user.roles?.icon || 'üë§'} ${roleName}
                        </span>
                    </td>
                    <td class="status-${user.status}">${user.status || 'active'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button onclick="editUser('${user.id}')" class="btn btn-sm">‚úèÔ∏è Modifier</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateStats(users) {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalSuperAdmins').textContent = 
                users.filter(u => u.is_super_admin).length;
            document.getElementById('totalAdmins').textContent = 
                users.filter(u => u.roles?.name === 'admin').length;
            document.getElementById('activeUsers').textContent = 
                users.filter(u => u.status === 'active' || !u.status).length;
        }

        // Initialisation
        loadAdminData();

        // Gestion d√©connexion
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>